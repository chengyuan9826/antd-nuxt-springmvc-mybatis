<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper PUBLIC   
    "-//mybatis.org//DTD Mapper 3.0//EN"  
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.report.dao.report.ReportMapper">
	<resultMap type="com.report.model.report.Report" id="BaseReportResultMap">
		<result column="user_id" property="userId" />
		<result column="username" property="username" />
		<result column="count" property="count" />
		<result column="file_type" property="fileType" />
	</resultMap>


	<!-- 查询报表 -->
	<select id="queryReport" parameterType="java.util.Map"
		resultMap="BaseReportResultMap">
        SELECT
            t.user_id,
            t.username,
            count( 0 ) count
        FROM
        (
            SELECT DISTINCT
                a.id post_id,
                b.id user_id,
                b.display_name username,
                <if test="fileType !=null">#{fileType} file_type,
                </if>
                count( 0 ) count
            FROM
                wp_posts a,
                wp_users b,
                wp_term_relationships c,
                wp_term_taxonomy d,
                wp_terms e
            WHERE
                a. post_status = 'publish'
                AND d.taxonomy = 'category'
                AND a.post_author = b.id
                AND a.id  = c.object_id
                AND c.term_taxonomy_id = d.term_taxonomy_id
                AND d.term_id = e.term_id
                <if test="fileType !=null">
                    AND (a.post_content LIKE concat('%&lt;a%.',#{fileType},'">%') AND e.term_id not in (31,30,32))
                </if>
                <if test="notLikeUserName !=null">
                    AND b.display_name NOT LIKE CONCAT('%',#{notLikeUserName},'%')
                </if>
                <if test="likeUserName !=null">
                    AND b.display_name LIKE CONCAT('%',#{likeUserName},'%')
                </if>
                <if test="startTime !=null">
                    AND a.post_date >= #{startTime}
                </if>
                <if test="endTime !=null">
                    AND a.post_date &lt;= #{endTime}
                </if>
                <if test="termId !=null">
                    AND e.term_id = #{termId}
                </if>
                <if test="likeUserName !=null">
                    AND b.display_name LIKE CONCAT('%',#{likeUserName},'%')
                </if>
            GROUP BY
        a.id,
                b.ID,b.display_name
            HAVING 1=1
            <if test="minNum !=null">
                AND count <![CDATA[>]]> #{minNum}
            </if>
            <if test="maxNum !=null">
                AND count <![CDATA[<]]> #{maxNum}
            </if>

        ) t
        GROUP BY
        t.user_id,
        t.username
        HAVING
        1 = 1
    </select>

    <!--插入一篇文章-->
    <insert id="insertPost" parameterType="com.report.model.wp.Post" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO wp_posts ( post_author, post_date, post_date_gmt, post_content, post_title, post_excerpt, post_status, post_name, post_modified, post_modified_gmt, post_parent, to_ping, pinged, post_content_filtered,post_type,post_mime_type )
        VALUES
        (#{post_author},#{post_date},#{post_date_gmt},#{post_content},#{post_title},#{post_excerpt},#{post_status},#{post_name},#{post_modified},#{post_modified_gmt},#{post_parent},#{to_ping},#{pinged},#{post_content_filtered},#{post_type},#{post_mime_type});
    </insert>
    <!--插入termrelations-->
    <insert id="insertTermRelations" parameterType="java.util.Map">
        INSERT INTO wp_term_relationships ( object_id, term_taxonomy_id, term_order )
        VALUES
	    (#{post_id}, #{term_id}, 0);
    </insert>
    <!--插入metadata-->
    <insert id="insertPostMeta" parameterType="com.report.model.wp.PostMeta">
        INSERT INTO wp_postmeta (  post_id, meta_key, meta_value )
        VALUES
	    (#{post_id},#{meta_key},#{meta_value})
    </insert>
</mapper>